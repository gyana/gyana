{% with parents=node.parents.all %}

<turbo-frame id="workflow-node">
  {% if node.kind == "input" or parents %}
  <div class="workflow-detail__sidebar">
    {% if node.kind == "filter" %}
    <turbo-frame id="node-{{ node.id }}-filters" src="{% url 'filters:list' %}"> </turbo-frame>
    {% else %}
    <form class="h-full overflow-auto" action="{% url 'workflows:node' workflow.id node.id %}" 
      {% if add_columns_formset or edit_columns_formset or aggregations_formset%}
      data-controller="live-create trigger" method="get"
      {% else %}
      data-controller="trigger" method="post"
      {% endif %}
      data-trigger-event-value="node-updated-{{ node.id }}" data-action="submit->trigger#dispatch"
      >
      {% csrf_token %}

      {% include "django/forms/default_form.html" %}

      {% if columns_formset %}
      <fieldset>
        <label>Add columns</label>
        {% include "components/formset.html" with formset=columns_formset %}
      </fieldset>
      {% endif %}

      {% if aggregations_formset %}
      <fieldset>
        <label>Add aggregates</label>
        {% include "components/formset.html" with formset=aggregations_formset %}
      </fieldset>
      {% endif %}

      {% if sort_columns_formset %}
      <fieldset>
        <label>Add columns</label>
        {% include "components/formset.html" with formset=sort_columns_formset %}
      </fieldset>
      {% endif %}

      {% if edit_columns_formset %}
      <fieldset>
        <label>Edit columns</label>
        {% include "components/formset.html" with formset=edit_columns_formset %}
      </fieldset>
      {% endif %}

      {% if add_columns_formset %}
      <fieldset>
        <label>Add columns</label>
        {% include "components/formset.html" with formset=add_columns_formset %}
      </fieldset>
      {% endif %}

      {% if rename_columns_formset %}
      <fieldset>
        <label>Rename columns</label>
        {% include "components/formset.html" with formset=rename_columns_formset %}
      </fieldset>
      {% endif %}

      <div className='flex flex-row gap-4 flex-1 items-end'>
        <button 
          {% if add_columns_formset or edit_columns_formset or aggregations_formset%}
          type="button"
          data-action="click->tf-modal#close click->live-create#create click->trigger#dispatch"
          {% else %}
          type='submit' 
          data-action="click->tf-modal#close"
          {% endif %}
          class="button button--filled button--sm" 
          value='save' 
          name='save-close'
        >
          Save 
        </button>
        <button 
          {% if add_columns_formset or edit_columns_formset or aggregations_formset%}
          type="button"
          data-action="click->live-create#create_preview click->trigger#dispatch"
          {% else %}
          type='submit' 
          {% endif %}
          class="button button--filled button--green button--sm" 
          name='save-preview'
          value='save-preview'
        >
          Save & Preview  
        </button>
      </div>
    </form>
    {% endif %}
  </div>

  <div class="workflow-detail__table">
    <nav class="tabbar">
      {% for parent in parents %}
      <a class="tabbar__link {% if preview_node_id == parent.id %} tabbar__link--active {% endif %}"
         href="{% url 'workflows:node' workflow.id node.id %}?preview_node_id={{ parent.id }}{% if request.GET.preview %}&preview=true{% endif %}">
        Input {% if parents|length > 1 %} {{ forloop.counter }} {% endif %}
      </a>
      {% endfor %}
      <a class="tabbar__link  {% if preview_node_id == node.id %} tabbar__link--active {% endif %}"
         href="{% url 'workflows:node' workflow.id node.id %}?preview_node_id={{ node.id }}{% if request.GET.preview %}&preview=true{% endif %}">
        Result
      </a>
    </nav>

    {% if request.GET.preview %}
    <turbo-frame id="workflows-grid" src="{% url 'workflows:grid' workflow.id preview_node_id %}">
      Loading...
    </turbo-frame>
    {% else %}
    <div class='workflow-detail__load-preview'>
      <a class='flex flex-row items-center'
         href="{% url 'workflows:node' workflow.id node.id %}?preview_node_id={{ preview_node_id }}&preview=true">
        <i class='fad fa-redo fa-lg'></i>
        <span class='font-semibold text-black-50'>Load preview</span>
      </a>
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class='workflow-detail__warning'>
    <span>You need to <strong>connect</strong> this node before you can configure it.</span>
    <span class='mt-12'><i class="fad fa-stethoscope fa-10x"></i></span>
  </div>
  {% endif %}
</turbo-frame>

{% endwith %}
